/*
 * KaiOS - VGA Graphics Driver
 * Mode 13h (320x200 256 colors) implementation
 */

#include "include/drivers/graphics.h"
#include "include/drivers/io.h"
#include "include/kernel/string.h"

// VGA registers
#define VGA_MISC_WRITE      0x3C2
#define VGA_SEQ_INDEX       0x3C4
#define VGA_SEQ_DATA        0x3C5
#define VGA_GC_INDEX        0x3CE
#define VGA_GC_DATA         0x3CF
#define VGA_CRTC_INDEX      0x3D4
#define VGA_CRTC_DATA       0x3D5
#define VGA_AC_INDEX        0x3C0
#define VGA_AC_WRITE        0x3C0
#define VGA_AC_READ         0x3C1
#define VGA_INSTAT_READ     0x3DA
#define VGA_DAC_WRITE_INDEX 0x3C8
#define VGA_DAC_DATA        0x3C9

// Video memory
static uint8_t* const VGA_MEMORY = (uint8_t*)0xA0000;
static uint8_t back_buffer[GFX_WIDTH * GFX_HEIGHT];
static bool graphics_mode = false;

// Clipping rectangle
static int16_t clip_x = 0;
static int16_t clip_y = 0;
static int16_t clip_w = GFX_WIDTH;
static int16_t clip_h = GFX_HEIGHT;

// 8x8 bitmap font (basic ASCII 32-127)
static const uint8_t font8x8[96][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // Space
    {0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00}, // !
    {0x6C,0x6C,0x24,0x00,0x00,0x00,0x00,0x00}, // "
    {0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00}, // #
    {0x18,0x3E,0x60,0x3C,0x06,0x7C,0x18,0x00}, // $
    {0x00,0xC6,0xCC,0x18,0x30,0x66,0xC6,0x00}, // %
    {0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00}, // &
    {0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00}, // '
    {0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00}, // (
    {0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00}, // )
    {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00}, // *
    {0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00}, // +
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30}, // ,
    {0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00}, // -
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00}, // .
    {0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00}, // /
    {0x7C,0xC6,0xCE,0xD6,0xE6,0xC6,0x7C,0x00}, // 0
    {0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00}, // 1
    {0x7C,0xC6,0x06,0x1C,0x30,0x66,0xFE,0x00}, // 2
    {0x7C,0xC6,0x06,0x3C,0x06,0xC6,0x7C,0x00}, // 3
    {0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x1E,0x00}, // 4
    {0xFE,0xC0,0xC0,0xFC,0x06,0xC6,0x7C,0x00}, // 5
    {0x38,0x60,0xC0,0xFC,0xC6,0xC6,0x7C,0x00}, // 6
    {0xFE,0xC6,0x0C,0x18,0x30,0x30,0x30,0x00}, // 7
    {0x7C,0xC6,0xC6,0x7C,0xC6,0xC6,0x7C,0x00}, // 8
    {0x7C,0xC6,0xC6,0x7E,0x06,0x0C,0x78,0x00}, // 9
    {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00}, // :
    {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x30}, // ;
    {0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x00}, // <
    {0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00}, // =
    {0x60,0x30,0x18,0x0C,0x18,0x30,0x60,0x00}, // >
    {0x7C,0xC6,0x0C,0x18,0x18,0x00,0x18,0x00}, // ?
    {0x7C,0xC6,0xDE,0xDE,0xDE,0xC0,0x78,0x00}, // @
    {0x38,0x6C,0xC6,0xFE,0xC6,0xC6,0xC6,0x00}, // A
    {0xFC,0x66,0x66,0x7C,0x66,0x66,0xFC,0x00}, // B
    {0x3C,0x66,0xC0,0xC0,0xC0,0x66,0x3C,0x00}, // C
    {0xF8,0x6C,0x66,0x66,0x66,0x6C,0xF8,0x00}, // D
    {0xFE,0x62,0x68,0x78,0x68,0x62,0xFE,0x00}, // E
    {0xFE,0x62,0x68,0x78,0x68,0x60,0xF0,0x00}, // F
    {0x3C,0x66,0xC0,0xC0,0xCE,0x66,0x3A,0x00}, // G
    {0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0x00}, // H
    {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, // I
    {0x1E,0x0C,0x0C,0x0C,0xCC,0xCC,0x78,0x00}, // J
    {0xE6,0x66,0x6C,0x78,0x6C,0x66,0xE6,0x00}, // K
    {0xF0,0x60,0x60,0x60,0x62,0x66,0xFE,0x00}, // L
    {0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0x00}, // M
    {0xC6,0xE6,0xF6,0xDE,0xCE,0xC6,0xC6,0x00}, // N
    {0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00}, // O
    {0xFC,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00}, // P
    {0x7C,0xC6,0xC6,0xC6,0xC6,0xCE,0x7C,0x0E}, // Q
    {0xFC,0x66,0x66,0x7C,0x6C,0x66,0xE6,0x00}, // R
    {0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00}, // S
    {0x7E,0x7E,0x5A,0x18,0x18,0x18,0x3C,0x00}, // T
    {0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00}, // U
    {0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x00}, // V
    {0xC6,0xC6,0xC6,0xD6,0xD6,0xFE,0x6C,0x00}, // W
    {0xC6,0xC6,0x6C,0x38,0x6C,0xC6,0xC6,0x00}, // X
    {0x66,0x66,0x66,0x3C,0x18,0x18,0x3C,0x00}, // Y
    {0xFE,0xC6,0x8C,0x18,0x32,0x66,0xFE,0x00}, // Z
    {0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00}, // [
    {0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00}, // backslash
    {0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00}, // ]
    {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00}, // ^
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF}, // _
    {0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00}, // `
    {0x00,0x00,0x78,0x0C,0x7C,0xCC,0x76,0x00}, // a
    {0xE0,0x60,0x7C,0x66,0x66,0x66,0xDC,0x00}, // b
    {0x00,0x00,0x7C,0xC6,0xC0,0xC6,0x7C,0x00}, // c
    {0x1C,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00}, // d
    {0x00,0x00,0x7C,0xC6,0xFE,0xC0,0x7C,0x00}, // e
    {0x3C,0x66,0x60,0xF8,0x60,0x60,0xF0,0x00}, // f
    {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0xF8}, // g
    {0xE0,0x60,0x6C,0x76,0x66,0x66,0xE6,0x00}, // h
    {0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00}, // i
    {0x06,0x00,0x0E,0x06,0x06,0x66,0x66,0x3C}, // j
    {0xE0,0x60,0x66,0x6C,0x78,0x6C,0xE6,0x00}, // k
    {0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, // l
    {0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xD6,0x00}, // m
    {0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x00}, // n
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0x00}, // o
    {0x00,0x00,0xDC,0x66,0x66,0x7C,0x60,0xF0}, // p
    {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0x1E}, // q
    {0x00,0x00,0xDC,0x76,0x60,0x60,0xF0,0x00}, // r
    {0x00,0x00,0x7E,0xC0,0x7C,0x06,0xFC,0x00}, // s
    {0x30,0x30,0xFC,0x30,0x30,0x36,0x1C,0x00}, // t
    {0x00,0x00,0xCC,0xCC,0xCC,0xCC,0x76,0x00}, // u
    {0x00,0x00,0xC6,0xC6,0xC6,0x6C,0x38,0x00}, // v
    {0x00,0x00,0xC6,0xD6,0xD6,0xFE,0x6C,0x00}, // w
    {0x00,0x00,0xC6,0x6C,0x38,0x6C,0xC6,0x00}, // x
    {0x00,0x00,0xC6,0xC6,0xC6,0x7E,0x06,0xFC}, // y
    {0x00,0x00,0x7E,0x4C,0x18,0x32,0x7E,0x00}, // z
    {0x0E,0x18,0x18,0x70,0x18,0x18,0x0E,0x00}, // {
    {0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00}, // |
    {0x70,0x18,0x18,0x0E,0x18,0x18,0x70,0x00}, // }
    {0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00}, // ~
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // DEL
};

// Write to VGA registers
static void vga_write_regs(const uint8_t* regs) {
    // Make a local copy we can modify
    uint8_t local_regs[64];
    for (int i = 0; i < 60; i++) {
        local_regs[i] = regs[i];
    }
    
    const uint8_t* r = local_regs;
    
    // Write MISC register
    outb(VGA_MISC_WRITE, *r++);
    
    // Write SEQ registers
    for (int i = 0; i < 5; i++) {
        outb(VGA_SEQ_INDEX, i);
        outb(VGA_SEQ_DATA, *r++);
    }
    
    // Unlock CRTC
    outb(VGA_CRTC_INDEX, 0x03);
    outb(VGA_CRTC_DATA, inb(VGA_CRTC_DATA) | 0x80);
    outb(VGA_CRTC_INDEX, 0x11);
    outb(VGA_CRTC_DATA, inb(VGA_CRTC_DATA) & ~0x80);
    
    // Write CRTC registers
    for (int i = 0; i < 25; i++) {
        outb(VGA_CRTC_INDEX, i);
        outb(VGA_CRTC_DATA, *r++);
    }
    
    // Write GC registers
    for (int i = 0; i < 9; i++) {
        outb(VGA_GC_INDEX, i);
        outb(VGA_GC_DATA, *r++);
    }
    
    // Write AC registers
    for (int i = 0; i < 21; i++) {
        inb(VGA_INSTAT_READ);
        outb(VGA_AC_INDEX, i);
        outb(VGA_AC_WRITE, *r++);
    }
    
    // Enable video
    inb(VGA_INSTAT_READ);
    outb(VGA_AC_INDEX, 0x20);
}

// Mode 13h register values
static const uint8_t mode13h_regs[] = {
    // MISC
    0x63,
    // SEQ
    0x03, 0x01, 0x0F, 0x00, 0x0E,
    // CRTC
    0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0xBF, 0x1F,
    0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x9C, 0x0E, 0x8F, 0x28, 0x40, 0x96, 0xB9, 0xA3, 0xFF,
    // GC
    0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x0F, 0xFF,
    // AC
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
    0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
    0x41, 0x00, 0x0F, 0x00, 0x00
};

void gfx_init(void) {
    // Switch to mode 13h
    vga_write_regs(mode13h_regs);
    
    // Setup our custom palette
    gfx_setup_palette();
    
    // Clear screen
    gfx_clear(COLOR_BLACK);
    gfx_swap_buffers();
    
    graphics_mode = true;
}

void gfx_exit(void) {
    // Switch back to text mode (mode 3)
    // This is simplified - a full implementation would restore text mode registers
    graphics_mode = false;
}

bool gfx_is_initialized(void) {
    return graphics_mode;
}

void gfx_setup_palette(void) {
    // Set custom colors for GUI
    gfx_set_palette_color(COLOR_DESKTOP_BG,    0, 32, 48);     // Dark teal desktop
    gfx_set_palette_color(COLOR_TASKBAR,       12, 12, 16);    // Dark taskbar
    gfx_set_palette_color(COLOR_TASKBAR_DARK,  6, 6, 8);       // Darker taskbar
    gfx_set_palette_color(COLOR_WINDOW_BG,     58, 58, 58);    // Window background
    gfx_set_palette_color(COLOR_WINDOW_TITLE,  20, 40, 60);    // Window title bar
    gfx_set_palette_color(COLOR_BUTTON,        48, 48, 48);    // Button
    gfx_set_palette_color(COLOR_BUTTON_LIGHT,  63, 63, 63);    // Button highlight
    gfx_set_palette_color(COLOR_BUTTON_DARK,   24, 24, 24);    // Button shadow
    gfx_set_palette_color(COLOR_MENU_BG,       52, 52, 52);    // Menu background
    gfx_set_palette_color(COLOR_MENU_SELECT,   32, 48, 63);    // Menu selection
    gfx_set_palette_color(COLOR_ICON_FOLDER,   63, 55, 20);    // Folder icon color
    gfx_set_palette_color(COLOR_ICON_FILE,     50, 50, 55);    // File icon color
}

void gfx_set_palette_color(uint8_t index, uint8_t r, uint8_t g, uint8_t b) {
    outb(VGA_DAC_WRITE_INDEX, index);
    outb(VGA_DAC_DATA, r);
    outb(VGA_DAC_DATA, g);
    outb(VGA_DAC_DATA, b);
}

void gfx_clear(uint8_t color) {
    memset(back_buffer, color, GFX_WIDTH * GFX_HEIGHT);
}

void gfx_putpixel(int16_t x, int16_t y, uint8_t color) {
    // Clipping
    if (x < clip_x || x >= clip_x + clip_w || y < clip_y || y >= clip_y + clip_h) {
        return;
    }
    back_buffer[y * GFX_WIDTH + x] = color;
}

uint8_t gfx_getpixel(int16_t x, int16_t y) {
    if (x < 0 || x >= GFX_WIDTH || y < 0 || y >= GFX_HEIGHT) {
        return 0;
    }
    return back_buffer[y * GFX_WIDTH + x];
}

void gfx_swap_buffers(void) {
    memcpy(VGA_MEMORY, back_buffer, GFX_WIDTH * GFX_HEIGHT);
}

void gfx_hline(int16_t x, int16_t y, int16_t width, uint8_t color) {
    for (int16_t i = 0; i < width; i++) {
        gfx_putpixel(x + i, y, color);
    }
}

void gfx_vline(int16_t x, int16_t y, int16_t height, uint8_t color) {
    for (int16_t i = 0; i < height; i++) {
        gfx_putpixel(x, y + i, color);
    }
}

void gfx_line(int16_t x0, int16_t y0, int16_t x1, int16_t y1, uint8_t color) {
    // Bresenham's line algorithm
    int16_t dx = x1 - x0;
    int16_t dy = y1 - y0;
    int16_t sx = (dx > 0) ? 1 : -1;
    int16_t sy = (dy > 0) ? 1 : -1;
    
    if (dx < 0) dx = -dx;
    if (dy < 0) dy = -dy;
    
    int16_t err = dx - dy;
    
    while (1) {
        gfx_putpixel(x0, y0, color);
        
        if (x0 == x1 && y0 == y1) break;
        
        int16_t e2 = 2 * err;
        if (e2 > -dy) {
            err -= dy;
            x0 += sx;
        }
        if (e2 < dx) {
            err += dx;
            y0 += sy;
        }
    }
}

void gfx_rect(int16_t x, int16_t y, int16_t w, int16_t h, uint8_t color) {
    gfx_hline(x, y, w, color);
    gfx_hline(x, y + h - 1, w, color);
    gfx_vline(x, y, h, color);
    gfx_vline(x + w - 1, y, h, color);
}

void gfx_fillrect(int16_t x, int16_t y, int16_t w, int16_t h, uint8_t color) {
    for (int16_t j = 0; j < h; j++) {
        for (int16_t i = 0; i < w; i++) {
            gfx_putpixel(x + i, y + j, color);
        }
    }
}

void gfx_rect_3d(int16_t x, int16_t y, int16_t w, int16_t h, uint8_t light, uint8_t dark, bool raised) {
    if (raised) {
        gfx_hline(x, y, w, light);
        gfx_vline(x, y, h, light);
        gfx_hline(x, y + h - 1, w, dark);
        gfx_vline(x + w - 1, y, h, dark);
    } else {
        gfx_hline(x, y, w, dark);
        gfx_vline(x, y, h, dark);
        gfx_hline(x, y + h - 1, w, light);
        gfx_vline(x + w - 1, y, h, light);
    }
}

void gfx_putchar(int16_t x, int16_t y, char c, uint8_t fg, uint8_t bg) {
    uint8_t uc = (uint8_t)c;
    if (uc < 32 || uc > 127) uc = '?';
    
    const uint8_t* glyph = font8x8[uc - 32];
    
    for (int16_t row = 0; row < 8; row++) {
        uint8_t bits = glyph[row];
        for (int16_t col = 0; col < 8; col++) {
            if (bits & (0x80 >> col)) {
                gfx_putpixel(x + col, y + row, fg);
            } else if (bg != 255) {  // 255 = transparent background
                gfx_putpixel(x + col, y + row, bg);
            }
        }
    }
}

void gfx_puts(int16_t x, int16_t y, const char* str, uint8_t fg, uint8_t bg) {
    int16_t cx = x;
    while (*str) {
        if (*str == '\n') {
            y += 8;
            cx = x;
        } else {
            gfx_putchar(cx, y, *str, fg, bg);
            cx += 8;
        }
        str++;
    }
}

int gfx_text_width(const char* str) {
    int width = 0;
    while (*str) {
        if (*str != '\n') width += 8;
        str++;
    }
    return width;
}

void gfx_blit(int16_t x, int16_t y, int16_t w, int16_t h, const uint8_t* data) {
    for (int16_t j = 0; j < h; j++) {
        for (int16_t i = 0; i < w; i++) {
            gfx_putpixel(x + i, y + j, data[j * w + i]);
        }
    }
}

void gfx_blit_transparent(int16_t x, int16_t y, int16_t w, int16_t h, const uint8_t* data, uint8_t trans_color) {
    for (int16_t j = 0; j < h; j++) {
        for (int16_t i = 0; i < w; i++) {
            uint8_t pixel = data[j * w + i];
            if (pixel != trans_color) {
                gfx_putpixel(x + i, y + j, pixel);
            }
        }
    }
}

void gfx_set_clip(int16_t x, int16_t y, int16_t w, int16_t h) {
    clip_x = x;
    clip_y = y;
    clip_w = w;
    clip_h = h;
}

void gfx_reset_clip(void) {
    clip_x = 0;
    clip_y = 0;
    clip_w = GFX_WIDTH;
    clip_h = GFX_HEIGHT;
}
